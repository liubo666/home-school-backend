# 应用基础配置
server:
  port: 8089
  servlet:
    encoding:
      charset: UTF-8
      enabled: true
      force: true

spring:
  profiles:
    active: dev  # 激活开发环境

  application:
    name: home-school-backend

  # 数据源公共配置（环境特定参数由dev配置覆盖）
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver  # 主配置保留驱动，避免重复
    url: jdbc:mysql://${DB_HOST:localhost}:${DB_PORT:3306}/${DB_NAME:home_school}?useUnicode=true&characterEncoding=utf8&useSSL=${USE_SSL:false}&serverTimezone=Asia/Shanghai&allowPublicKeyRetrieval=true
    username: ${DB_USERNAME:root}  # 支持环境变量注入，优先级更高
    password: ${DB_PASSWORD:root}

  # JPA公共配置（开发环境的show-sql等在dev中单独设置）
  jpa:
    hibernate:
      ddl-auto: none  # 公共策略：禁止自动建表
    properties:
      hibernate:
        dialect: org.hibernate.dialect.MySQL8Dialect
        format_sql: true
        use_sql_comments: true
        jdbc:
          batch_size: 25
        order_inserts: true
        order_updates: true
        generate_statistics: false  # 开发环境可开启，主配置默认关闭
        transaction:
          jta:
            platform: org.hibernate.service.jta.platform.internal.NoJtaPlatform
    open-in-view: false  # 关闭懒加载隐患

  # Redis公共配置（连接池参数通用，环境特定的host/port在dev中覆盖）
  data:
    redis:
      database: 0
      timeout: 3000ms
      lettuce:
        pool:
          max-active: 20
          max-idle: 10
          min-idle: 5
          max-wait: 3000ms
          time-between-eviction-runs: 30000ms

  # 缓存公共配置（Redis缓存策略通用）
  cache:
    type: redis
    redis:
      time-to-live: 3600000  # 1小时
      cache-null-values: false
      use-key-prefix: true
      key-prefix: "home-school:"

  # Jackson全局配置（日期、序列化规则通用）
  jackson:
    time-zone: GMT+8
    date-format: yyyy-MM-dd HH:mm:ss
    property-naming-strategy: SNAKE_CASE
    default-property-inclusion: non_null
    serialization:
      write-dates-as-timestamps: false
      fail-on-empty-beans: false
    deserialization:
      fail-on-unknown-properties: false

  # 文件上传公共限制（大小限制通用）
  servlet:
    multipart:
      max-file-size: 10MB
      max-request-size: 10MB
      enabled: true
      file-size-threshold: 0


# 日志公共配置（输出格式、文件路径通用，级别由dev覆盖）
logging:
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"
  file:
    name: logs/home-school-backend.log
    max-size: 100MB
    max-history: 30
    total-size-cap: 1GB

# JWT配置（密钥支持环境变量，避免硬编码敏感信息）
jwt:
  secret: ${JWT_SECRET:mySecretKey123456789012345678901234567890}  # 生产环境必须通过环境变量注入
  expiration: 86400000  # 24小时
  refresh-expiration: 604800000  # 7天
  issuer: home-school-backend

# MinIO公共配置（环境特定的bucket在dev中覆盖）
minio:
  endpoint: ${MINIO_ENDPOINT:http://localhost:9000}
  access-key: ${MINIO_ACCESS_KEY:minioadmin}
  secret-key: ${MINIO_SECRET_KEY:minioadmin}
  bucket-name: home-school  # 生产环境桶名
  region: us-east-1

# Knife4j公共配置（文档元信息通用，开发环境开启debug）
knife4j:
  enable: true
  openapi:
    title: 家校协同教育系统API文档
    description: 家校协同教育系统后端接口文档
    version: 1.0.0
    concat-contact: true
    contact:
      name: Home School Team
      email: dev@homeschool.com
      url: https://www.homeschool.com
    license: Apache 2.0
    license-url: https://www.apache.org/licenses/LICENSE-2.0
    terms-of-service-url: https://www.homeschool.com/terms
  setting:
    language: zh-CN
    enable-swagger-models: true
    enable-document-manage: true
    swagger-model-name: 实体类列表
    enable-version: false
    enable-reload-cache-parameter: false
    enable-after-script: true
    enable-filter-multipart-api-method-type: POST
    enable-filter-multipart-apis: false
    enable-request-cache: true
    enable-host: false
    enable-host-text: localhost:8080
    enable-home-custom: false
    home-custom-location: classpath:markdown/home.md
    enable-search: true
    enable-footer: false
    enable-footer-custom: true
    footer-custom-content: Copyright © 2024 Home School Team
    enable-dynamic-parameter: false
    enable-open-api: true
    enable-group: true
  cors: true
  production: false  # 开发环境默认关闭生产模式
  basic:
    enable: false  # 开发环境关闭基础认证（方便调试）
    username: admin
    password: 123456

# Actuator公共配置（生产环境限制暴露，开发环境在dev中放开）
management:
  endpoints:
    web:
      base-path: /actuator
    jmx:
      exposure:
        include:  # 禁用JMX端点
  jmx:
    enabled: false  # 全局禁用JMX，避免安全风险
  endpoint:
    health:
      show-components: always
    metrics:
      enabled: true
    prometheus:
      enabled: true
  metrics:
    export:
      prometheus:
      enabled: true
    distribution:
      percentiles-histogram:
        http.server.requests: true
      percentiles:
        http.server.requests: 0.5, 0.95, 0.99
    tags:
      application: home-school-backend
    web:
      server:
        request:
          autotime:
            nabled: true
  info:
    env:
      enabled: true
    git:
      mode: full

# 自定义配置（通用业务参数，无环境差异）
app:
  storage:
    type: minio  # local/minio/oss
    local:
      base-path: /var/home-school/files
    allowed-types: .jpg,.jpeg,.png,.gif,.pdf,.doc,.docx,.xls,.xlsx
    max-size: 10485760  # 10MB

  security:
    allowed-origins:
      - http://localhost:8080
      - http://localhost:3000
      - http://127.0.0.1:8080
      - http://127.0.0.1:3000
      - http://192.168.0.112:8080
      - http://192.168.0.112:3000
      - http://192.168.*:8080
      - http://192.168.*:3000
    allowed-methods: [GET, POST, PUT, DELETE, OPTIONS]
    allowed-headers: ["*"]
    allow-credentials: true
    max-age: 3600

  excel:
    max-rows: 10000
    chunk-size: 1000
    temp-dir: /tmp/excel-import

  cache:
    default-ttl: 3600  # 1小时
    user-ttl: 1800     # 30分钟
    data-ttl: 7200     # 2小时
    max-size: 10000

  page:
    default-size: 20
    max-size: 100

  password:
    min-length: 6
    max-length: 20
    require-uppercase: false
    require-lowercase: false
    require-digit: false
    require-special: false

  performance:
    monitoring:
      enabled: false  # 开发环境可在dev中开启
    test:
      enabled: false